# Product Architecture

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
- [P1 Ingestion](#p1-ingestion)
- [P2 Tasks & Subtasks](#p2-tasks--subtasks)
- [P3 Calendar Sync FSM](#p3-calendar-sync-fsm)
- [P4 Calendar Cancel](#p4-calendar-cancel)
- [P5 Signals: Drift / Overload / State](#p5-signals-drift--overload--state)

## P1 Ingestion

1. –¶–µ–ª—å —Ñ–∞–∑—ã (P1)

–û–±–µ—Å–ø–µ—á–∏—Ç—å –Ω–∞–¥—ë–∂–Ω—ã–π –ø—É—Ç—å:

Telegram (—Ç–µ–∫—Å—Ç / –≥–æ–ª–æ—Å) ‚Üí Inbox ‚Üí Calendar

—Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π, —á—Ç–æ:

–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è

–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ

–≤–Ω–µ—à–Ω–∏–µ —Å–±–æ–∏ (Google Calendar) –Ω–µ –ª–æ–º–∞—é—Ç —Å–∏—Å—Ç–µ–º—É

2. –í—Ö–æ–¥—ã (Input)

–¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram

–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram

–î–æ–ø—É—â–µ–Ω–∏—è:

—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω–æ–π

–≤—Ä–µ–º—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ

—Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è

3. –û—Å–Ω–æ–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏

item

inbox_queue

calendar_event_id

attempts

last_error

tg_result_sent (–±–∏—Ç–æ–≤–∞—è –º–∞—Å–∫–∞)

4. –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã P1 (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)

–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ –ø–æ—Ä–æ–∂–¥–∞–µ—Ç item

Item –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ (status)

–°–æ–∑–¥–∞–Ω–∏–µ item –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

Calendar ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∏ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π

–û–¥–∏–Ω item ‚Üí –Ω–µ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ CREATED / SUCCESS / DEAD —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

–û—à–∏–±–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–µ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –ø–æ—Ç–µ—Ä–µ item

FAILED ‚Äî —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è non-transient –æ—à–∏–±–æ–∫

5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–µ)

–ü—Ä–∏ –ø—Ä–∏—ë–º–µ:

üéß –ü—Ä–∏–Ω—è–ª. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é‚Ä¶ (voice)

–ü—Ä–∏–Ω—è—Ç–æ. –í –æ—á–µ—Ä–µ–¥–∏: N. (text)

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ item (–æ–¥–∏–Ω —Ä–∞–∑):

–°–æ–∑–¥–∞–Ω–æ: #ID (status).

–°–æ–∑–¥–∞–Ω–æ: #ID (status). –ü–æ—Å—Ç–∞–≤–ª—é –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å. (meeting)

–ü—Ä–∏ —É—Å–ø–µ—Ö–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–æ–¥–∏–Ω —Ä–∞–∑):

‚úÖ –í –∫–∞–ª–µ–Ω–¥–∞—Ä–µ: DD.MM.YYYY HH:MM ‚Äî <title>

–ü—Ä–∏ —Ñ–∞—Ç–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–æ–¥–∏–Ω —Ä–∞–∑):

‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å. –ó–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, –≤–µ—Ä–Ω—É –≤ Inbox. [CAL-DEAD]

‚ùå –ù–µ—Ç:

—Ç–µ—Ö–Ω–æ-fallback

–ø–æ–≤—Ç–æ—Ä–æ–≤

–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

6. –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
–¢–∏–ø –æ—à–∏–±–∫–∏	–ü–æ–≤–µ–¥–µ–Ω–∏–µ
calendar not configured	item –æ—Å—Ç–∞—ë—Ç—Å—è, retry –Ω–µ –¥–µ–ª–∞–µ–º
429 / 5xx / timeout	retry –¥–æ –ª–∏–º–∏—Ç–∞
401 / 403 / 404	FAILED + CAL-DEAD
internal worker error	–ª–æ–≥ + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ item
7. –ö—Ä–∏—Ç–µ—Ä–∏–∏ DONE (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

 CREATED / SUCCESS / DEAD ‚Äî –∞—Ç–æ–º–∞—Ä–Ω—ã

 –î—É–±–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã

 Calendar –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ service account

 Google Calendar —Ä–µ–∞–ª—å–Ω–æ —Å–æ–∑–¥–∞—ë—Ç —Å–æ–±—ã—Ç–∏—è

 Debug —É–±—Ä–∞–Ω –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ–ª–æ—É

 P1 –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç future multi-user

 –ö–æ–¥ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã —Ç–µ–≥–æ–º

8. –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Ñ–∏–∫—Å–∞—Ü–∏–∏

git tag: p1-pr2-calendar-tg-ordering

—Ä–∞–±–æ—á–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

RUNBOOK –æ–±–Ω–æ–≤–ª—ë–Ω

PRD —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–∫—Ä—ã—Ç—ã–º

## P2 Tasks & Subtasks

P2 ‚Äî Tasks & Subtasks

–í–µ—Ä—Å–∏—è: v0.1
–°—Ç–∞—Ç—É—Å: APPROVED
–û—Å–Ω–æ–≤–∞–Ω –Ω–∞:

Product Vision (—Å–º. `Docs/01_PRODUCT_VISION.md`)

P1 Ingestion (—Å–º. —Ä–∞–∑–¥–µ–ª P1 –≤ —ç—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ)

–° —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞:

P2 —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ñ–∞–∑–æ–π

–ª—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞–¥–∞—á–∞—Ö/–ø–æ–¥–∑–∞–¥–∞—á–∞—Ö ‚Äî —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö P2

–≤—Å—ë, —á—Ç–æ –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ P2, –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ –Ω–µ –¥–µ–ª–∞–µ–º

–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏
–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

–º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å –∫–æ–¥ –±–µ–∑ —Ä–∏—Å–∫–∞ –ø–µ—Ä–µ–¥–µ–ª–æ–∫ –ø–æ —Å–º—ã—Å–ª—É

—á—ë—Ç–∫–æ –ø–æ–Ω—è—Ç–Ω–æ:

–≥–ª—É–±–∏–Ω–∞ –∏–µ—Ä–∞—Ä—Ö–∏–∏

—Å—Ç–∞—Ç—É—Å—ã

—á—Ç–æ –Ω–µ –¥–µ–ª–∞–µ–º

–î–ª—è –º–µ–Ω—è (–∫–∞–∫ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)

—è –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞—é:

–ø—Ä–æ–µ–∫—Ç—ã

–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

–¥–µ–¥–ª–∞–π–Ω—ã

—Å–ª–æ–∂–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

—è –æ—Ç–ª–∞–≤–ª–∏–≤–∞—é –Ω–∞—Ä—É—à–µ–Ω–∏—è –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ P2 —Å—Ä–∞–∑—É

–ß—Ç–æ –¥–∞–ª—å—à–µ –ª–æ–≥–∏—á–Ω–æ —Å–¥–µ–ª–∞—Ç—å

–¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –¥–≤–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞.

üîπ –í–∞—Ä–∏–∞–Ω—Ç 1. –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ P2 ‚Üí –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é

–¢–æ –µ—Å—Ç—å:

–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î

–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã / —Ñ—Ä–∞–∑—ã

—Å—Ç—Ä–æ–≥–∏–π MVP (–±–µ–∑ UX-—Ñ–∞–Ω—Ç–∞–∑–∏–π)

üëâ –ó–∞–¥–∞—á–∞ –¥–ª—è Codex: P2 Stage 1 ‚Äî Data Model + Core Ops

üîπ –í–∞—Ä–∏–∞–Ω—Ç 2. –°–Ω–∞—á–∞–ª–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å ‚Äú—á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –í–ò–î–ò–¢‚Äù

–¢–æ –µ—Å—Ç—å:

–∫–∞–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

–∫–∞–∫–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

–∫–∞–∫–∏–µ –æ—à–∏–±–∫–∏

üëâ P2 UX Contract (–∫–æ—Ä–æ—Ç–∫–∏–π, 1 —ç–∫—Ä–∞–Ω)

---
Implementation status

Implemented and verified: Stage 1‚Äì9.
Runtime API host port: 8101 (internal 8000).
Worker command server: 8002 (internal).
Deployment caveat: `google_sa.json` must be a file (was a dir‚Üífile mismatch).

## P3 Calendar Sync FSM

# P3 ‚Äî Calendar States (FSM + Responsibilities)

## 1. –¶–µ–ª—å
–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π FSM –∑–∞–¥–∞—á –∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –¥–æ–º–µ–Ω–æ–º –∑–∞–¥–∞—á –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π.

## 2. –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- `tasks.state` ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞.
- `planned_at` ‚Äî –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
- Calendar ‚Äî side-effect, —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π —Ç–æ–ª—å–∫–æ worker tick-–∞–º–∏.

## 3. FSM –∑–∞–¥–∞—á–∏ (–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π)
**–°–æ—Å—Ç–æ—è–Ω–∏—è:** NEW, PLANNED, SCHEDULED, DONE, FAILED, CANCELLED.

**–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:**
From | To | Trigger
--- | --- | ---
NEW | PLANNED | plan_task
PLANNED | SCHEDULED | calendar create/patch success
SCHEDULED | PLANNED | re-plan (plan_task)
SCHEDULED | DONE | complete_task
SCHEDULED | FAILED | terminal failure (reserved)
SCHEDULED | CANCELLED | cancel (explicit tick)
PLANNED | DONE | complete_task
PLANNED | CANCELLED | cancel (explicit tick)

**–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:**
- DONE / FAILED / CANCELLED ‚Üí NEW / PLANNED / SCHEDULED
- –õ—é–±—ã–µ Calendar ‚Üí Task –ø–µ—Ä–µ—Ö–æ–¥—ã

## 4. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
**Task domain:**
- –≤–ª–∞–¥–µ–µ—Ç `tasks.state` –∏ `planned_at`;
- –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è;
- –Ω–µ –∑–Ω–∞–µ—Ç –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ.

**Calendar adapter:**
- –¥–µ–ª–∞–µ—Ç side-effects (create / patch / cancel);
- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (ok, http_status, err);
- –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç `tasks.state` –Ω–∞–ø—Ä—è–º—É—é.

**Sync ticks:**
- `create_tick` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è PLANNED –∑–∞–¥–∞—á;
- `update_tick` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è replanned;
- `cancel_tick` ‚Äî –æ—Ç–º–µ–Ω–∞ —Å–æ–±—ã—Ç–∏—è –¥–ª—è CANCELLED –∑–∞–¥–∞—á.

## 5. UX-–ø—Ä–æ–µ–∫—Ü–∏—è
–í Telegram –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è **—Ä—É—Å—Å–∫–∏–µ** —Å—Ç–∞—Ç—É—Å—ã. –ú–∞–ø–ø–∏–Ω–≥ —Å–º. –≤ `Docs/01_PRODUCT_VISION.md`.

## 6. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –ù–µ—Ç Calendar ‚Üí Task –∞–≤—Ç–æ–ª–æ–≥–∏–∫–∏.
- –ù–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–π –∏ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü.

**–°—Ç–∞—Ç—É—Å:** DONE

## P4 Calendar Cancel

# P4 ‚Äî Calendar Cancel

## 1. –¶–µ–ª—å
–û–±–µ—Å–ø–µ—á–∏—Ç—å —è–≤–Ω—É—é –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—É—é –æ—Ç–º–µ–Ω—É –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∑–∞–¥–∞—á –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ CANCELLED.

## 2. –¢—Ä–∏–≥–≥–µ—Ä
- `tasks.state == CANCELLED`
- `calendar_event_id IS NOT NULL`

## 3. –ü–æ–≤–µ–¥–µ–Ω–∏–µ cancel_tick
1. `cancel_tick` –≤—ã–±–∏—Ä–∞–µ—Ç –∑–∞–¥–∞—á–∏ –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä—É.
2. Calendar adapter –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–º–µ–Ω–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ.
3. –†–µ–∑—É–ª—å—Ç–∞—Ç:
   - –£—Å–ø–µ—Ö (2xx) ‚Üí –æ—á–∏—Å—Ç–∏—Ç—å `calendar_event_id`.
   - 404 ‚Üí —Å—á–∏—Ç–∞—Ç—å —É—Å–ø–µ—Ö–æ–º, –æ—á–∏—Å—Ç–∏—Ç—å `calendar_event_id`.
   - –ò–Ω–∞—è –æ—à–∏–±–∫–∞ ‚Üí –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —Ç–∏–∫–µ.

## 4. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–º–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞.
- 404 ‚Äî –Ω–µ –æ—à–∏–±–∫–∞.
- –û—á–∏—Å—Ç–∫–∞ `calendar_event_id` –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ü–∏–∫–ª.

## 5. –î–∞–Ω–Ω—ã–µ
- `tasks.state` **–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è**.
- `planned_at` **–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è**.
- –ù–æ–≤—ã–µ –ø–æ–ª—è –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è.

## 6. –í–∞–∂–Ω–æ
**–û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á–∏ ‚â† —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∏–∑ –ë–î.**
–ó–∞–¥–∞—á–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∫–∞–∫ ¬´–û—Ç–º–µ–Ω–µ–Ω–∞¬ª.

**–°–Ω—è—Ç—å —Å –ø–ª–∞–Ω–∞** ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–Ω–µ CANCELLED).
–°–º. `Docs/01_PRODUCT_VISION.md`.

**–°—Ç–∞—Ç—É—Å:** DONE

## P5 Signals: Drift / Overload / State

# P5 ‚Äî Calendar Drift Detection (log-only)

## 1. –¶–µ–ª—å
–û–±–Ω–∞—Ä—É–∂–∏–≤–∞—Ç—å –∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è (drift) –º–µ–∂–¥—É –æ–∂–∏–¥–∞–Ω–∏—è–º–∏ —Å–∏—Å—Ç–µ–º—ã –ø–æ –∑–∞–¥–∞—á–µ –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Å–æ–±—ã—Ç–∏—è –≤ Google Calendar ‚Äî –±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.

## 2. –ö–∞–Ω–æ–Ω
- `tasks.state` ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã.
- Calendar –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω—ë–Ω –≤—Ä—É—á–Ω—É—é.
- P5 —Ç–æ–ª—å–∫–æ –Ω–∞–±–ª—é–¥–∞–µ—Ç (log-only). –ù–∏–∫–∞–∫–∏—Ö write –≤ –ë–î. –ù–∏–∫–∞–∫–∏—Ö mutating –≤—ã–∑–æ–≤–æ–≤ –≤ Calendar API.
- –ù–∏–∫–∞–∫–æ–π –∞–≤—Ç–æ–ª–æ–≥–∏–∫–∏ Calendar ‚Üí Task.

## 3. Drift types (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)

### 3.1 missing_event
–£—Å–ª–æ–≤–∏–µ:
- `tasks.state == SCHEDULED`
- `calendar_event_id IS NOT NULL`
- Calendar API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404

–°–º—ã—Å–ª: —Å–æ–±—ã—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é.

### 3.2 time_mismatch
–£—Å–ª–æ–≤–∏–µ:
- `tasks.state == SCHEDULED`
- `planned_at != calendar_event.start`

–°–º—ã—Å–ª: —Å–æ–±—ã—Ç–∏–µ –ø–µ—Ä–µ–Ω–µ—Å–ª–∏ –≤—Ä—É—á–Ω—É—é.

### 3.3 unexpected_event
–£—Å–ª–æ–≤–∏–µ:
- `tasks.state IN (DONE, FAILED, CANCELLED)`
- `calendar_event_id IS NOT NULL`
- Calendar API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–±—ã—Ç–∏–µ

–°–º—ã—Å–ª: —Å–æ–±—ã—Ç–∏–µ –æ—Å—Ç–∞–ª–æ—Å—å, —Ö–æ—Ç—è –∑–∞–¥–∞—á–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª—å–Ω–∞—è.

### 3.4 state_mismatch (reserved)
–£—Å–ª–æ–≤–∏–µ:
- Calendar event status == cancelled
- `tasks.state == SCHEDULED`

–°–º—ã—Å–ª: —Å–æ–±—ã—Ç–∏–µ –æ—Ç–º–µ–Ω–∏–ª–∏ –≤—Ä—É—á–Ω—É—é.

## 4. Detector tick (P5)
- `_p5_calendar_drift_tick(limit=5)`
- –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `CALENDAR_SYNC_MODE == full`
- –í—ã–±–æ—Ä –∑–∞–¥–∞—á: `calendar_event_id IS NOT NULL`, —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
- –î–µ–π—Å—Ç–≤–∏–µ: `events().get(...)` + —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ existence/start/status
- –†–µ–∑—É–ª—å—Ç–∞—Ç: —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏

## 5. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–ü—Ä–µ—Ñ–∏–∫—Å:
- `P5_CALENDAR_DRIFT`

–§–æ—Ä–º–∞—Ç—ã:
- `P5_CALENDAR_DRIFT action=check task_id=... calendar_event_id=...`
- `P5_CALENDAR_DRIFT drift_type=missing_event task_id=... calendar_event_id=...`
- `P5_CALENDAR_DRIFT drift_type=time_mismatch task_id=... planned_at=... calendar_start=...`
- `P5_CALENDAR_DRIFT drift_type=unexpected_event terminal_state=... task_id=... calendar_event_id=...`
- `P5_CALENDAR_DRIFT action=error task_id=... err=...`

## 6. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ë–î.
- –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Calendar.
- –ù–µ—Ç Calendar ‚Üí Task –∞–≤—Ç–æ–ª–æ–≥–∏–∫–∏.
- –¢–æ–ª—å–∫–æ log-only –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å.

**–°—Ç–∞—Ç—É—Å:** PLANNED
