# Регламент работы системы

## 1. Сущности

### Item
Универсальная сущность:
- задача (`task`)
- встреча (`meeting`)
- заметка (опционально)

### Статусы items
- `inbox` — требует разбора/уточнения
- `active` — в работе / встреча запланирована
- `waiting`
- `done`
- `canceled`

---

## 2. Inbox (канон)

- Всё новое сначала попадает в `inbox`.
- `inbox` — это **не список задач**, это буфер управления.
- `inbox` должен регулярно разбираться.

Правило управления:
> Inbox старше 48 часов — ошибка управления.

---

## 3. Очередь входящих событий (Stage B2)

### Зачем
Telegram polling (`getUpdates`) **не является очередью** и не гарантирует ровно-один-раз.

### Канон обработки
1) `telegram-bot` — только принимает вход и пишет в `inbox_queue` (SQLite).
2) `organizer-worker` — **один потребитель** (single consumer): claim → обработка → mark.
3) Дубликаты защищены уникальным ключом: `(source, tg_chat_id, tg_update_id)`.

### Состояния inbox_queue
- `NEW` — готово к обработке
- `CLAIMED` — взято воркером по lease
- `DONE` — успешно обработано
- `FAILED` — ошибка, будет ретрай
- `DEAD` — превышен лимит попыток

Lease:
- `B2_CLAIM_LEASE_SEC` — время lease
- reaper переводит `CLAIMED -> NEW`, если lease истёк и `attempts < B2_MAX_ATTEMPTS`.

Backpressure:
- `B2_QUEUE_MAX_NEW`, `B2_QUEUE_MAX_TOTAL`,
- при превышении и `B2_BACKPRESSURE_MODE=reject` бот отвечает пользователю «очередь перегружена».

---

## 4. Встречи и календарь (Stage B3–B4)

### Принцип
- Встреча считается «сформированной», только когда есть **start_at + end_at**.
- До этого она может существовать как запись в `inbox` (маркер/неопределённость).
- Если `start_at/end_at` отсутствуют, **calendar sync не вызывается**, и включается уточнение.

### Маркер неопределённости времени
Если время не распознано или двусмысленно (например «в 9» без «утра/вечера»):
- item остаётся в `inbox`,
- пользователю отправляется запрос на уточнение.

### Уточнение (канал управления)
- Команда: `/set #ID [сегодня|завтра|послезавтра|DD.MM] [в] HH[:MM] [мин]`
- Inline-кнопки: **Утро / Вечер / Отменить**

Правило:
- Любой ответ пользователя в период «ожидающего уточнения» трактуется как **уточнение**, а не как создание нового item.

---

## 5. Интеграция с Google Calendar

### Поля интеграции (items)
- `calendar_event_id`:
  - `NULL` — событие не создавалось
  - `PENDING` — создание события отложено / будет повторено worker
  - `FAILED` — исчерпаны попытки, требуется ручная проверка
  - `<id>` — реальный идентификатор события Google Calendar

- `attempts` — число попыток
- `last_error` — последняя ошибка (если была)
- `updated_at` — время последнего изменения интеграционных полей

### Канон поведения
- Источник истины — БД. Календарь — производное представление.
- Worker идемпотентный: повторная обработка не должна создавать дубликаты.
- При `PENDING` — worker делает retry до лимита.
- После `attempts >= лимита` → `FAILED`, требуется вмешательство.

---

## 6. Напоминания (пока политика)

- Задачи: 24ч и 2ч
- Встречи: 60мин и 10мин

---

## 7. Обновление канона

Правило:
- обсуждения — в чатах,
- решения — в этих файлах,
- если решения нет в файле — его не существует.

---

## Регламент стадий

- Stage 0 — обязательная техническая валидация (E2E)
- Stage B2/B3/B4 — допускаются как внутренние этапы Stage 0
- nginx/certbot/домены/webhook — только после стабильного Stage 0
