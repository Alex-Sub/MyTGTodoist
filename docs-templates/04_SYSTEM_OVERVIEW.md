СИСТЕМНЫЙ ОБЗОР

## 1) Назначение

Архитектура разделена на слои, чтобы:

- ML не исполнял команды и не менял состояние.
- Runtime не интерпретировал смысл и не "угадывал".
- Состояние менялось только в одном месте.

## 2) Роли слоёв (границы обязательны)

### ML-core (внешний)
- Понимает запрос пользователя.
- Возвращает `intent + entities + candidates`.
- Не пишет в БД и не выполняет бизнес-операции.

### Runtime / Worker
- Единственный writer состояния.
- Валидирует обязательные поля canon'а.
- Задаёт один уточняющий вопрос, если данных не хватает.
- Исполняет intent детерминированно.

### API (read-only)
- Отдаёт текущее состояние.
- Не изменяет данные.

### Telegram UX
- Показывает информацию, кнопки и сценарии.
- Не хранит бизнес-правила исполнения.
- Для изменений состояния всегда обращается к Runtime.

## Timezone (system-wide)

- Системная таймзона во всех сервисах: `Europe/Moscow`.
- Контейнеры получают `TZ=Europe/Moscow`.
- Telegram adapter передаёт `X-Timezone` в ML Gateway из `APP_TIMEZONE` (fallback `TIMEZONE`), по умолчанию `Europe/Moscow`.

## 3) Обязательная ежедневная сводка (Daily Digest)

Daily digest обязателен как ежедневный управленческий ритуал.
В digest должны быть метрики:

- активные цели,
- просроченные цели,
- цели со сроком сегодня/завтра,
- цели под риском,
- задачи на сегодня,
- задачи на завтра.

Из digest пользователь должен переходить к реальным спискам и действиям.

## 4) Поток данных

Пользователь -> Telegram UX -> ML-core -> Runtime -> БД -> API/ответ пользователю.

Для handoff в новом чате используйте `HANDOFF.md` как единый источник операционного контекста.

## 5) Подтверждённая прод-топология (final)

```text
VPS
  - telegram-bot
  - organizer-worker
  - organizer-api
  - reverse endpoint: 127.0.0.1:19000
        ||
        || reverse SSH tunnel (VM -> VPS)
        \/
VM
  - ML-Gateway: 127.0.0.1:9000
        ||
        || local processing
        \/
  - ASR + ffmpeg normalization
```

Порты:
- VM: `9000` (ML-Gateway)
- VPS: `19000` (tunnel endpoint for ML traffic)
