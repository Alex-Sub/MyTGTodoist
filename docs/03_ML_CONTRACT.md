ML CONTRACT

Версия: согласовано с ML-core v1.4

## 1) Главный принцип

ML понимает, Runtime исполняет.

- ML-core отвечает за интерпретацию естественного языка.
- Runtime отвечает за валидацию и изменение состояния.
- Runtime не "додумывает" смысл, ML не выполняет команды.

## 2) Формат входа в Runtime (CommandEnvelope)

```json
{
  "trace_id": "...",
  "source": {...},
  "text": {...},
  "command": {
    "intent": "...",
    "confidence": 0.0,
    "entities": {...}
  }
}
```

## 3) Обязанности ML-core

- Определить один intent.
- Извлечь entities.
- При неоднозначности передать candidates.
- Не выбирать сам при низкой уверенности.

Пример `task_ref`:

```json
{
  "query": "...",
  "candidates": [...],
  "chosen_id": null,
  "ask": "..."
}
```

Если `chosen_id` отсутствует, Runtime задаёт уточняющий вопрос.

## 4) Обязанности Runtime

- Проверить обязательные поля по `canon/intents_v2.yml`.
- При нехватке данных вернуть один уточняющий вопрос.
- При достаточных данных выполнить intent детерминированно.
- Вернуть структурированный результат выполнения.

## 5) Поведение при неуверенности/отказе ML

Если ML вернул `rejected` или очень низкую уверенность, Runtime не выполняет действие и возвращает безопасный ответ:

`"Я не понял команду. Сформулируйте иначе."`

## 6) Формат ответа Runtime

Успех:

```json
{
  "ok": true,
  "user_message": "..."
}
```

Уточнение:

```json
{
  "ok": false,
  "clarifying_question": "...",
  "choices": [...]
}
```
