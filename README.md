# todo-telegram-calendar

Проект объединяет Telegram-бота и HTTP API, чтобы управлять задачами и событиями календаря через привычный чат-интерфейс. В основе — FastAPI для веб-части и aiogram для обработки апдейтов Telegram, с единым входом и централизованной конфигурацией через `.env`.

Стартовая структура подготовлена под SQLite и планировщик задач, с логированием в stdout и файл. Дальше будет добавлена схема БД, интеграции с Google Calendar и экспорт данных.

## Установка зависимостей

```bash
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
```

## FastAPI (dev)

```bash
uvicorn src.api.app:app --reload
```

## Alembic

```bash
alembic revision --autogenerate -m "init"
alembic upgrade head
```

## Тесты

```bash
pytest
```

## Режимы запуска

В проде используется webhook (FastAPI принимает апдейты). В dev удобнее polling.

- `DEV_POLLING=true` - запуск long polling
- иначе - запуск FastAPI через uvicorn

## ASR (voice)

Для распознавания голоса бот использует внешний ASR-сервис. Настройте переменные окружения:

- `ASR_URL` (например `http://localhost:8088`)
- `ASR_API_KEY`
- `ASR_TIMEOUT_SECONDS` (по умолчанию 180)

## Подтверждение действий (NLU/voice)

Команды с `/` выполняются сразу. Для NLU (обычный текст/голос) при высокой уверенности бот отправляет предпросмотр и кнопки подтверждения.

Минимальная проверка вручную:

- Отправьте обычный текст без `/` (или голос) с понятной командой.
- Убедитесь, что бот прислал предпросмотр и кнопки ✅/✏️/❌.
- Нажмите ✅ — действие выполняется.
- Нажмите ✏️ — бот попросит корректировку, следующее сообщение создаёт новый черновик.

### Smoke-тесты (ручные)

1) CREATE_MEETING без даты → запрос даты → "завтра" → preview → ✅ → создано.
2) CREATE_MEETING без времени → запрос времени.
3) Неверная дата → повторный запрос даты.
4) Pending expired → ✅ → "Черновик устарел. Повтори команду."
5) LLM выключен → поведение только rule-based, preview при conf>=0.6.
